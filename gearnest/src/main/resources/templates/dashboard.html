<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>GearNest</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" th:href="@{/images/logo.png}" type="image/x-icon">
    <style>
        /* --- CHAT TOGGLE BUTTON --- */
        .chat-toggle-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-white);
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chat-toggle-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .chat-toggle-button svg {
            width: 32px;
            height: 32px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .chat-toggle-button .icon-close {
            display: none;
        }

        /* --- CHAT WINDOW --- */
        .chat-window {
            position: fixed;
            bottom: 6.5rem;
            right: 2rem;
            width: 100%;
            max-width: 370px;
            height: 500px;
            background-color: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-xl);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            z-index: 999;
        }

        .chat-window.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* --- CHAT HEADER --- */
        .chat-header {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-white);
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            flex-shrink: 0;
        }

        /* --- CHAT MESSAGES --- */
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background-color: var(--color-background);
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        .bot-message {
            background-color: var(--color-gray-100);
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        .user-message {
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: var(--color-white);
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        /* The original CSS provided for the typing indicator was just empty spans, 
           so we add a basic animation here to show activity */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--color-primary);
            border-radius: 50%;
            margin: 0 2px;
            animation: dot-bounce 0.6s infinite ease-in-out alternate;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dot-bounce {
            from {
                transform: scale(0.8);
                opacity: 0.6;
            }

            to {
                transform: scale(1.2);
                opacity: 1;
            }
        }



        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- CHAT INPUT --- */
        .chat-input-form {
            display: flex;
            padding: 1rem;
            background-color: var(--color-white);
            border-top: 1px solid var(--color-gray-200);
            flex-shrink: 0;
        }

        .chat-input {
            flex-grow: 1;
            border: 1px solid var(--color-gray-300);
            padding: 0.75rem;
            border-radius: 1.5rem;
            background-color: var(--color-white);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(243, 122, 101, 0.2);
        }

        .send-button {
            width: 45px;
            height: 45px;
            margin-left: 0.75rem;
            border: none;
            border-radius: 50%;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .send-button:hover {
            transform: scale(1.1);
        }

        .send-button svg {
            width: 24px;
            height: 24px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .chat-window {
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
                max-width: 100%;
                border-radius: 0;
            }

            .chat-toggle-button {
                bottom: 1rem;
                right: 1rem;
            }
        }
    </style>

</head>

<body>
    <!-- The header fragment will be included here -->
    <header th:replace="~{fragments/header::header}"></header>

    <main>
        <!-- Hero Section with dynamic background image -->
        <section class='hero-section'
            th:style="'background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url(' + ${heroImageUrl} + ') no-repeat center center/cover;'">
            <div class='container'>
                <h1 class='animate-fade-in-up' style='animation-delay: 0.2s;'>Find The Perfect Garage For Your Vehicle
                </h1>
                <p class='animate-fade-in-up' style='animation-delay: 0.4s;'>Discover top-rated, verified garages in
                    Surat for any service you need.</p>
                <a href='#filter-section' class='btn btn-primary animate-fade-in-up'
                    style='animation-delay: 0.6s;'>Start Your Search</a>
            </div>
        </section>

        <!-- Filter Section (remains the same as your provided code) -->
        <section id='filter-section' class='filter-section scroll-animate'>
            <div class='container'>
                <div class="filter-header">
                    <h2>Find the best service for your vehicle</h2>
                    <p>Tell us what you're looking for, and we'll find the perfect match.</p>
                </div>
                <form id='filter-form'>
                    <div class='form-group location-group'>
                        <label for='location-filter'>Location (City)</label>
                        <div class='input-wrapper'>
                            <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'>
                                <path fill-rule='evenodd'
                                    d='M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z'
                                    clip-rule='evenodd' />
                            </svg>
                            <input type='text' id='location-filter' placeholder='e.g., Surat'>
                        </div>
                    </div>
                    <div class='form-group vehicle-type-group'>
                        <label>Vehicle Type</label>
                        <div class="vehicle-options">
                            <label class="vehicle-option selected"><input type="radio" name="vehicle-type" value="all"
                                    checked><span>All</span></label>
                            <label class="vehicle-option"><input type="radio" name="vehicle-type"
                                    value="car"><span>Car</span></label>
                            <label class="vehicle-option"><input type="radio" name="vehicle-type"
                                    value="bike"><span>Bike</span></label>
                        </div>
                    </div>
                    <div class='form-group rating-group'>
                        <label for='rating-filter'>Minimum Rating</label>
                        <select id='rating-filter'>
                            <option value='0'>All Ratings</option>
                            <option value='4.5'>★★★★½ & Up</option>
                            <option value='4'>★★★★ & Up</option>
                            <option value='3'>★★★ & Up</option>
                        </select>
                    </div>
                    <div class='form-group actions-group'>
                        <label style="opacity: 0;">Reset</label>
                        <button type='button' id='reset-filters-btn' class='btn btn-secondary'
                            style="width: 100%;">Reset</button>
                    </div>
                    <div class='form-group services-group'>
                        <label>Select Services (Optional)</label>
                        <div id='services-filter-container'>
                            <!-- Service checkboxes will be dynamically inserted here by your script.js -->
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- DYNAMIC GARAGE LISTINGS -->
        <section id='listings' class='garage-listings'>
            <div class='container' id='garage-container'>

                <!--
                  THYMELEAF LOOP:
                  This block will repeat for each 'garage' object in the '${garages}' list
                  provided by the HomeController.
                -->
                <div th:each="garage, iterStat : ${garages}" class='garage-card scroll-animate'
                    th:classappend="${iterStat.index > 0 ? 'delay-' + (iterStat.index * 100) : ''}" th:attr="data-city=${garage.city.name},
                              data-rating=${garage.averageRating},
                              data-services=${#strings.listJoin(garage.services.![value], ' ')},
                              data-vehicle=${#strings.listJoin(garage.vehicleTypes, ' ')}">

                    <div class="card-image-wrapper">
                        <!-- Use Thymeleaf to set the image source dynamically -->
                        <img th:src="@{/uploads/garage-cards/{image}(image=${garage.cardImage})}"
                            th:alt="${garage.garageName}" />
                    </div>
                    <div class='card-content'>
                        <h3 th:text="${garage.garageName}">Garage Name</h3>
                        <p class='card-location'>
                            <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'>
                                <path fill-rule='evenodd'
                                    d='M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z'
                                    clip-rule='evenodd' />
                            </svg>
                            <span th:text="${garage.address+', '+garage.city.name}">Full Garage
                                Address</span>
                        </p>
                        <!-- The rating will be generated by your existing JS based on this data attribute -->
                        <div class='rating-display' th:attr="data-rating-display=${garage.averageRating}"></div>

                        <div class='service-tags'>
                            <!-- Loop through the services for this specific garage -->
                            <span th:each="service : ${garage.services}" class='service-tag'
                                th:attr="data-service-value=${service.value}" th:text="${service.displayName}">
                                Service Name
                            </span>
                        </div>
                        <button class='btn btn-primary view-details-btn' th:attr="data-garage-id=${garage.id}">View
                            Details</button>
                    </div>
                </div>

                <!-- This message is controlled by your existing script.js for filtering -->
                <div id='no-results' style="display: none;">
                    <h3>No Garages Found</h3>
                    <p>Try adjusting your filters to find what you're looking for.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- The footer fragment will be included here -->
    <footer th:replace="~{fragments/footer::footer}"></footer>

    <!-- Details Modal (remains the same as your provided code) -->
    <div id='details-modal' class='modal-overlay'>
        <div id='modal-content' class='modal-content'>
            <!-- Modal content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle-button" id="chat-toggle">
        <svg class="icon-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.068.157 2.148.279 3.238.364.466.037.893.281 1.153.671L12 21l2.652-3.978c.26-.39.687-.634 1.153-.67 1.09-.086 2.17-.208 3.238-.365 1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
        </svg>
        <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <!-- Chat Window -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">Garage Assistant</div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot-message">
                Hello! How can I assist you with your vehicle today?
            </div>
        </div>
        <form class="chat-input-form" id="chat-form">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
            <button type="submit" class="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </form>
    </div>




    <!-- Your existing script.js -->
    <script th:src="@{/javascript/script.js}"></script>

</body>
<script>
    // --- Utility Function for Exponential Backoff (MUST be defined outside DOMContentLoaded) ---
    /**
     * Retries the API call using exponential backoff.
     */
    async function retryFetch(fn, retries = 5, delay = 1000) {
        try {
            return await fn();
        } catch (error) {
            if (retries > 0) {
                await new Promise(res => setTimeout(res, delay));
                return retryFetch(fn, retries - 1, delay * 2);
            }
            throw error;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const chatToggle = document.getElementById('chat-toggle');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const iconOpen = document.querySelector('.icon-open');
        const iconClose = document.querySelector('.icon-close');
        const sendButton = chatForm.querySelector('.send-button');

        // --- CHAT UI FUNCTIONS (Based on user's simple structure) ---
        const toggleChatWindow = (forceClose = false) => {
            const isActive = chatWindow.classList.contains('active');
            if (forceClose || isActive) {
                chatWindow.classList.remove('active');
                iconOpen.style.display = 'block';
                iconClose.style.display = 'none';
            } else {
                chatWindow.classList.add('active');
                iconOpen.style.display = 'none';
                iconClose.style.display = 'block';
                chatMessages.scrollTop = chatMessages.scrollHeight;
                chatInput.focus();
            }
        };

        function addMessage(text, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type);
            // Using textContent as per user's original structure (no message-bubble div needed)
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const typingIndicator = document.createElement('div');
            // Using ID for easy removal
            typingIndicator.id = 'typing-indicator';
            // Using user's classes/spans for indicator
            typingIndicator.classList.add('message', 'bot-message', 'typing-indicator');
            // Adding a simple indicator structure that CSS can style
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }


        async function getBotResponse(userInput) {
            addTypingIndicator();

            const systemPrompt = "You are a helpful and friendly garage assistant for a platform called GearNest. Keep your responses concise and focused on helping users with vehicle services.";
            const userQuery = userInput;

            const apiKey = "AIzaSyD1nbouKOuM06-HLC3Pa_BptgCpu9XqkrI";

            // FIX 2: Use the current, correct model
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // FIX 3: Reverting to the official top-level systemInstruction structure 
                // that is reliably accepted by the API endpoint:
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // FIX 4: Adding Google Search grounding tool
                tools: [{ "google_search": {} }],
            };

            try {
                const fetchOperation = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Check if the error response body is available for better debugging
                        const errorText = await response.text();
                        console.error("API Response Error Body:", errorText);
                        // Using a simple fallback error message for the user
                        const errorMsg = `API Error ${response.status}: Failed to get response.`;
                        throw new Error(errorMsg);
                    }
                    return response;
                };

                const response = await retryFetch(fetchOperation);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                removeTypingIndicator();

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.error("API response missing expected text content.", result);
                    return "I'm sorry, I couldn't generate a response. The API returned an empty result.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                removeTypingIndicator();
                return "Sorry, I'm having trouble connecting right now. Please try again later. (Error: API Request Failed)";
            }
        }


        // --- Event Handlers ---
        chatToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleChatWindow();
        });

        chatWindow.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        window.addEventListener('click', (e) => {
            if (chatWindow.classList.contains('active') && !e.target.closest('a, button, input, select')) {
                toggleChatWindow(true);
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            addMessage(messageText, 'user-message');
            chatInput.value = '';
            chatInput.disabled = true;
            sendButton.disabled = true;

            const botResponse = await getBotResponse(messageText);
            addMessage(botResponse, 'bot-message');
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        });


        // ---------------------------------------------------------------------
        // --- Main App Logic (Star Ratings, Filtering, Modal) ---
        // ---------------------------------------------------------------------

        // --- Element Selection ---
        const locationFilter = document.getElementById('location-filter');
        const ratingFilter = document.getElementById('rating-filter');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const garageContainer = document.getElementById('garage-container');
        const garageCards = document.querySelectorAll('.garage-card');
        const noResultsMessage = document.getElementById('no-results');
        const servicesFilterContainer = document.getElementById('services-filter-container');
        const vehicleTypeOptions = document.querySelectorAll('.vehicle-option');
        const modal = document.getElementById('details-modal');
        const modalContent = document.getElementById('modal-content');
        let serviceCheckboxes = [];

        // --- Star Rating Generation ---
        // Generates star icons (full, half, empty) based on a numerical rating.
        function generateStars(rating) {
            const fullStar = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'><path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' /></svg>`;
            const halfStar = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'><path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292zM10 12.956L12.247 14.4l-.585-2.51 1.823-1.66-2.52-.36L10 7.427v5.529z' /></svg>`;
            const emptyStar = `<svg style='color: #d1d5db;' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'><path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' /></svg>`;

            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (rating >= i) { starsHTML += fullStar; }
                else if (rating >= i - 0.5) { starsHTML += halfStar; }
                else { starsHTML += emptyStar; }
            }
            return `<div class='stars-container'>${starsHTML}</div><span class='rating-value'>${rating.toFixed(1)}</span>`;
        }

        // --- Dynamic Filter & Card Initialization ---
        // Populates the service filters based on the available garage services.
        function initializeDynamicFilters() {
            const serviceMap = new Map();
            garageCards.forEach(card => {
                card.querySelectorAll('.service-tag').forEach(tag => {
                    const value = tag.dataset.serviceValue;
                    const displayName = tag.textContent;
                    if (value && displayName && !serviceMap.has(value)) {
                        serviceMap.set(value, displayName);
                    }
                });
            });

            const sortedServices = new Map([...serviceMap.entries()].sort((a, b) => a[1].localeCompare(b[1])));
            servicesFilterContainer.innerHTML = ''; // Clear existing filters

            sortedServices.forEach((displayName, value) => {
                const checkboxHTML = `
                <label class='service-label'>
                    <input type='checkbox' name='service' value='${value}'>
                    <span>${displayName}</span>
                </label>`;
                servicesFilterContainer.insertAdjacentHTML('beforeend', checkboxHTML);
            });

            serviceCheckboxes = document.querySelectorAll('input[name="service"]');
            serviceCheckboxes.forEach(checkbox => checkbox.addEventListener('change', handleFilterChange));
        }

        // --- Filtering Logic ---
        // The main function that applies all active filters to the garage cards.
        function applyFilters() {
            const locationQuery = locationFilter.value.toLowerCase().trim();
            const minRating = parseFloat(ratingFilter.value);
            const selectedVehicle = document.querySelector('input[name="vehicle-type"]:checked').value;
            const selectedServices = Array.from(serviceCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            let visibleCards = 0;

            garageCards.forEach(card => {
                const cardCity = card.dataset.city.toLowerCase();
                const cardRating = parseFloat(card.dataset.rating);
                const cardServices = card.dataset.services.split(' ');
                const cardVehicles = card.dataset.vehicle.split(' ');
                const locationMatch = locationQuery === '' || cardCity.includes(locationQuery);
                const ratingMatch = cardRating >= minRating;
                const vehicleMatch = selectedVehicle === 'all' || cardVehicles.includes(selectedVehicle);
                const serviceMatch = selectedServices.length === 0 || selectedServices.every(service => cardServices.includes(service));

                if (locationMatch && ratingMatch && vehicleMatch && serviceMatch) {
                    card.style.display = 'block';
                    visibleCards++;
                } else {
                    card.style.display = 'none';
                }
            });

            noResultsMessage.style.display = visibleCards === 0 ? 'block' : 'none';
        }

        // Toggles the 'selected' class on filter labels and applies filters.
        function handleFilterChange(event) {
            const label = event.target.closest('label');
            if (label) {
                label.classList.toggle('selected', event.target.checked);
            }
            applyFilters();
        }

        function resetFilters() {
            locationFilter.value = '';
            ratingFilter.value = '0';

            vehicleTypeOptions.forEach(opt => opt.classList.remove('selected'));
            const allVehicleOption = document.querySelector('input[name="vehicle-type"][value="all"]');
            if (allVehicleOption) {
                allVehicleOption.checked = true;
                allVehicleOption.parentElement.classList.add('selected');
            }

            serviceCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.service-label').classList.remove('selected');
            });
            applyFilters();
        }

        // --- Modal Logic ---
        function showModal(card) {

            const title = card.querySelector('h3').textContent;
            const address = card.querySelector('.card-location span').textContent.trim();
            const rating = parseFloat(card.dataset.rating);
            const garageId = card.querySelector('.view-details-btn').dataset.garageId;
            const services = Array.from(card.querySelectorAll('.service-tag')).map(tag =>
                `<span class='service-tag' data-service-value='${tag.dataset.serviceValue}'>${tag.textContent}</span>`
            ).join('');

            modalContent.innerHTML = `
            <div class='modal-header'>
                <h2>${title}</h2>
                <button id='close-modal-btn' aria-label="Close modal">&times;</button>
            </div>
            <div class='modal-body'>
                <p class='modal-address'>${address}</p>
                <div class='rating-display'>${generateStars(rating)}</div>
                <h4>Services Offered:</h4>
                <div class='service-tags'>${services}</div>
            </div>
            <div class='modal-footer'>
                <a href="/user/book-service/${garageId}" class='btn btn-primary'>Book Service</a>
            </div>`;

            modal.classList.add('is-visible');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            document.getElementById('close-modal-btn').addEventListener('click', hideModal);
        }

        function hideModal() {
            modal.classList.remove('is-visible');
            document.body.style.overflow = 'auto';
        }

        // --- Scroll Animation Observer ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        // --- Event Listeners ---
        locationFilter.addEventListener('keyup', applyFilters);
        ratingFilter.addEventListener('change', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);

        vehicleTypeOptions.forEach(option => {
            option.addEventListener('click', () => {
                vehicleTypeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input').checked = true;
                applyFilters();
            });
        });

        garageContainer.addEventListener('click', (e) => {
            const detailsButton = e.target.closest('.view-details-btn');
            if (detailsButton) {
                showModal(detailsButton.closest('.garage-card'));
            }
        });

        modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideModal(); });

        // --- Initializations ---
        document.querySelectorAll('[data-rating-display]').forEach(el => {
            const rating = parseFloat(el.dataset.ratingDisplay);
            el.innerHTML = generateStars(rating);
        });

        initializeDynamicFilters();
        document.querySelectorAll('.scroll-animate').forEach(el => observer.observe(el));
    });

</script>

</html>