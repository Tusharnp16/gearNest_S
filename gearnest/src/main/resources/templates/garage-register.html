<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Garage Registration</title>
    <link rel="shortcut icon" th:href="@{/images/logo.png}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/garage-register.css}" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header th:replace="~{fragments/header::header}"></header>

    <section>
        <div class="container scroll-animate">
            <div class="title">
                <p>Register Your Garage</p>
            </div>

            <div th:if="${success}" class="success" th:text="${success}"></div>
            <div th:if="${error}" class="error" th:text="${error}"></div>

            <form th:action="@{/garage/register}" th:object="${garage}" method="post" autocomplete="off">
                <div class="user_details">

                    <div class="input_box">
                        <label for="ownerName">Owner Name:</label>
                        <input type="text" id="owner_name" placeholder="Enter your name" autocomplete="off" required />
                        <span class="error-message" id="ownerNameError"></span>

                    </div>

                    <div class="input_box">
                        <label for="garageName">Garage Name:</label>
                        <input type="text" id="garage_name" placeholder="Enter your garage name" autocomplete="off"
                            required />
                        <span class="error-message" id="garageNameError"></span>

                    </div>


                    <div class="input_box">
                        <label for="phoneNumber">Phone Number:</label>
                        <input type="text" id="phno" placeholder="Enter your number" autocomplete="off" required />
                        <span class="error-message" id="phnoError"></span>

                    </div>

                    <div class="input_box">
                        <label for="email">Email:</label>
                        <input type="email" id="email" placeholder="Enter your email" autocomplete="off" required />
                        <span class="error-message" id="emailError"></span>

                    </div>

                    <div class="input_box">
                        <label for="otp">OTP:</label>
                        <input type="text" id="otp" name="otp" placeholder="Enter your OTP" autocomplete="off" />
                        <span class="error-message" id="otpError"></span>
                    </div>
                    <div class="input_box" style="margin-top: 20px;">
                        <button type="button" id="generateOtp" class="btn btn-outline-primary">Generate OTP</button><br>
                        <p id="resendText" style="display: none;color: #555;">
                            You can resend OTP in <span id="countdown">120</span>
                        </p>
                    </div>

                    <div class="input_box" style="width: 100%;">
                        <label for="address">Address:</label>
                        <input type="text" id="address" placeholder="Full address" autocomplete="off" required />
                        <span class="error-message" id="addressError"></span>

                    </div>

                    <div class="input_box">
                        <label for="state">State:</label>
                        <select id="state" th:field="*{state}" required>
                            <option value="">Select</option>
                        </select>
                        <span class="error-message" id="stateError"></span>

                    </div>

                    <div class="input_box">
                        <label for="city">City:</label>
                        <select id="city" th:field="*{city}" required>
                            <option value="">Select</option>
                        </select>
                        <span class="error-message" id="cityError"></span>
                    </div>

                    <div class="input_box">
                        <label for="location">Landmark / Location:</label>
                        <input type="text" id="location" placeholder="Nearby or landmark" autocomplete="off" />
                        <span class="error-message" id="locationError"></span>

                    </div>

                    <div class="input_box">
                        <label for="openingHours">Opening Hours:</label>
                        <div style="display: flex;justify-content: space-between; align-items: center;">
                            <select name="openingHours" id="openingHours" style="margin: 5px;">
                                <option value="">-</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select name="openingHours_am_pm" id="openingHours_am_pm" style="margin: 5px;">
                                <option value="">-</option>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                            <h6 style="margin: 2px;">To</h6>
                            <select name="closingHours" id="closingHours" style="margin: 5px;">
                                <option value="">-</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select name="closingHours_am_pm" id="closingHours_am_pm" style="margin: 5px;">
                                <option value="">-</option>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        <span class="error-message" id="opnigHourseError"></span>

                    </div>

                    <div class="input_box" style="width: 100%;">
                        <label for="description">Description:</label>
                        <textarea id="description" placeholder="Brief about your garage..." autocomplete="off"
                            required></textarea>
                        <span class="error-message" id="descriptionError"></span>

                    </div>


                    <div class="input_box">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Create a password" autocomplete="off"
                            required />
                        <span class="error-message" id="passwordError"></span>

                    </div>

                    <div class="input_box">
                        <label for="confiremPassword">Confirm Password:</label>
                        <input type="password" id="confiremPassword" placeholder="Confirm Password" autocomplete="off"
                            required />
                        <span class="error-message" id="confiremPasswordError"></span>
                    </div>

                    <div class="input_box" style="display: flex;width: 100%;">
                        <input type="checkbox" id="terms" required style="margin-right: 10px;">
                        <label for="terms">I agree to the <a href="#">Terms and Conditions</a></label>
                        <span class="error-message" id="termsError"></span>

                    </div>
                </div>

                <div class="reg_btn">
                    <input type="submit" value="Register">
                </div>
                <div class="user_details_login">
                    <div class="input_box" style="text-align: center;">
                        <p>Have already an account? <a href="/login" style="text-decoration: none;">Login</a></p>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <footer th:replace="~{fragments/footer::footer}"></footer>

    <script th:src="@{/javascript/sweetalert2@11.js}"></script>

    <script th:src="@{javascript/jquery-3.7.1.min.js}"></script>

    <script th:src="@{/javascript/script.js}"></script>


    <script>

        document.addEventListener('DOMContentLoaded', () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) { entry.target.classList.add('is-visible'); }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.scroll-animate').forEach(el => observer.observe(el));
        });

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        let emailExists = false;
        let phoneExists = false;

        // Load states
        $.ajax({
            url: "/api/location/states",
            method: "GET",
            success: function (states) {
                $.each(states, function (i, state) {
                    $('#state').append('<option value="' + state.id + '">' + state.name + '</option>');
                });
            }
        });

        // Load cities on state change
        $("#state").on("change", function () {
            let stateId = $(this).val();
            $('#city').empty().append('<option value="">Select</option>');
            if (stateId) {
                $.ajax({
                    url: "/api/location/cities/" + stateId,
                    method: "GET",
                    success: function (cities) {
                        $.each(cities, function (i, city) {
                            $('#city').append('<option value="' + city.id + '">' + city.name + '</option>');
                        });
                    }
                });
            }
        });


        // OTP logic
        let countdownInterval;
        const initialSeconds = 120;

        $('#generateOtp').click(function () {
            let email = $('#email').val();
            if (!email || !emailRegex.test(email) || emailExists) {
                Swal.fire({ icon: "error", title: "Oops...", text: "Enter a valid and available email to get OTP" });
                return;
            }

            Swal.fire({ title: "Sending OTP...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            $.ajax({
                url: "/api/garage/register/send-otp",
                method: "POST",
                data: { email: email },
                success: function () {
                    Swal.close();
                    Swal.fire({ title: "OTP sent!", icon: "success" });

                    $('#email').prop('disabled', true);
                    $('#generateOtp').hide();
                    $('#resendText').show();
                    startCountdown(initialSeconds);
                },
                error: function () {
                    Swal.close();
                    Swal.fire({ icon: "error", title: "Oops...", text: "Error sending OTP. Try again." });
                }
            });
        });

        function startCountdown(seconds) {
            let remaining = seconds;
            $('#countdown').text(remaining);
            countdownInterval = setInterval(function () {
                remaining--;
                $('#countdown').text(remaining);
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    $('#generateOtp').show();
                    $('#resendText').hide();
                    $('#email').prop('disabled', false);
                }
            }, 1000);
        }

        // jQuery validation and submission
        $(document).ready(function () {
            function showError(id, message) {
                $(`#${id}`).text(message).show();
            }

            function clearError(id) {
                $(`#${id}`).text('').hide();
            }

            const nameRegex = /^[a-zA-Z\s]{3,}$/;
            const phoneRegex = /^[6-9]\d{9}$/;
            const addressRegex = /^.{10,}$/;
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{6,}$/;

            $('#owner_name').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('ownerNameError', 'Owner name is required');
                else if (!nameRegex.test(val)) showError('ownerNameError', 'Only letters, min 3 characters');
                else clearError('ownerNameError');
            });

            $('#garage_name').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('garageNameError', 'Garage name is required');
                else if (!nameRegex.test(val)) showError('garageNameError', 'Only letters, min 3 characters');
                else clearError('garageNameError');
            });


            $('#phno').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') {
                    showError('phnoError', 'Phone number is required');
                } else if (!phoneRegex.test(val)) {
                    showError('phnoError', 'Enter a valid 10-digit number');
                } else {
                    // AJAX check if phone exists
                    $.ajax({
                        url: "/api/garage/register/check-phone",
                        method: "POST",
                        data: { phone: val },
                        success: function (exists) {
                            exists ? showError('phnoError', 'Phone number already exists') : clearError('phnoError');
                        },
                        error: function () {
                            showError('phnoError', 'Error validating phone');
                        }
                    });
                }
            });

            $('#email').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') {
                    showError('emailError', 'Email is required');
                } else if (!emailRegex.test(val)) {
                    showError('emailError', 'Enter a valid email address');
                } else {
                    // AJAX check if email exists
                    $.ajax({
                        url: "/api/garage/register/check-email",
                        method: "POST",
                        data: { email: val },
                        success: function (exists) {
                            if (exists === true) {
                                showError("emailError", "Email already exists");
                                emailExists = true;
                            } else {
                                clearError("emailError");
                                emailExists = false;
                            }
                        },
                        error: function () {
                            showError('emailError', 'Error validating email');
                        }
                    });
                }
            });

            $('#otp').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('otpError', 'OTP is required');
                else if (!/^\d{4,6}$/.test(val)) showError('otpError', 'Enter a valid 4â€“6 digit OTP');
                else clearError('otpError');
            });

            $('#address').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('addressError', 'Address is required');
                else if (!addressRegex.test(val)) showError('addressError', 'Minimum 10 characters');
                else clearError('addressError');
            });

            $('#location').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('locationError', 'Location is required');
                else if (val.length < 3) showError('locationError', 'Must be at least 3 characters');
                else clearError('locationError');
            });

            $('#description').on('keyup', function () {
                const val = $(this).val().trim();
                if (val === '') showError('descriptionError', 'Description is required');
                else if (val.length < 10) showError('descriptionError', 'Minimum 10 characters');
                else clearError('descriptionError');
            });

            $('#password').on('keyup', function () {
                const val = $(this).val();
                if (val === '') showError('passwordError', 'Password is required');
                else if (!passwordRegex.test(val)) showError('passwordError', 'Min 6 chars, 1 capital & 1 number');
                else clearError('passwordError');
            });

            $('#confiremPassword').on('keyup', function () {
                const val = $(this).val();
                const pwd = $('#password').val();
                if (val === '') showError('confiremPasswordError', 'Please confirm your password');
                else if (val !== pwd) showError('confiremPasswordError', 'Passwords do not match');
                else clearError('confiremPasswordError');
            });

            $('#openingHours, #openingHours_am_pm, #closingHours, #closingHours_am_pm').on('change', function () {
                if ($('#openingHours').val() && $('#openingHours_am_pm').val() &&
                    $('#closingHours').val() && $('#closingHours_am_pm').val()) {
                    clearError('opnigHourseError');
                } else {
                    showError('opnigHourseError', 'Please select full opening and closing time');
                }
            });

            // $('#file-input').on('change', function () {
            //     if (this.files.length > 0) clearError('uploadImgError');
            //     else showError('uploadImgError', 'Logo file is required');s
            // });

            $('#terms').on('change', function () {
                $(this).is(':checked') ? clearError('termsError') : showError('termsError', 'You must agree to the terms');
            });

            // SUBMIT
            $('.reg_btn input[type="submit"]').click(function (e) {
                e.preventDefault();
                $('#owner_name, #garage_name, #phno, #email, #otp, #address, #description, #password, #confiremPassword, #select-input').trigger('keyup');
                $('#openingHours, #openingHours_am_pm, #closingHours, #closingHours_am_pm, #terms').trigger('change');

                const state = $('#state').val();
                const city = $('#city').val();
                state ? clearError('stateError') : showError('stateError', 'Please select a state');
                city ? clearError('cityError') : showError('cityError', 'Please select a city');


                if ($('.error-message:visible').length > 0) {
                    Swal.fire({ icon: 'error', title: 'Please fix all errors before submitting.' });
                    return;
                }

                const data = {
                    ownerName: $('#owner_name').val(),
                    garageName: $('#garage_name').val(),
                    phno: $('#phno').val(),
                    email: $('#email').val(),
                    otp: $('#otp').val(),
                    address: $('#address').val(),
                    state: { id: $('#state').val() },  // object with id
                    city: { id: $('#city').val() },    // object with id
                    openingHours: $('#openingHours').val() + ' ' + $('#openingHours_am_pm').val() + ' to ' + $('#closingHours').val() + ' ' + $('#closingHours_am_pm').val(),
                    description: $('#description').val(),
                    password: $('#password').val()

                };

                Swal.fire({ title: 'Submitting...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                $.ajax({
                    url: '/api/garage/register/submit',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        Swal.close();
                        Swal.fire({ position: "top-end", icon: "success", title: "Registered successfully!", showConfirmButton: false, timer: 2000 })
                            .then(() => window.location.href = "/login-user");
                    },
                    error: function (xhr) {
                        Swal.close();
                        console.log(data);
                        Swal.fire({ icon: "error", title: "Oops...", text: "Registration failed: " + xhr.responseText });
                    }
                });
            });
        });
    </script>


</body>

</html>