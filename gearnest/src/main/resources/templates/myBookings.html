<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Bookings - GearNest</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/mybookings.css}" />
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" th:href="@{/images/logo.png}" type="image/x-icon">
</head>
<style>
    /* New CSS for the no-bookings-message */
    #no-bookings-message {
        text-align: center;
        font-size: 1.25rem;
        font-weight: 500;
        color: #4a5568;
        padding: 2rem;
        border-radius: 8px;
        background-color: #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
    }
</style>

<body>
    <header th:replace="~{fragments/header::header}"></header>
    <main>
        <section class="page-section">
            <div class="container">
                <div class="section-title">
                    <h1>My Bookings</h1>
                </div>

                <div class="service-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="booked">Booked</button>
                    <button class="filter-btn" data-filter="in progress">In Progress</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                    <button class="filter-btn" data-filter="cancelled">Cancelled</button>
                </div>

                <div class="service-list">
                    <div id="no-bookings-message" th:if="${#lists.isEmpty(bookings)}" class="alert alert-info"
                        style="display: block;">
                        <h2>You have no bookings yet.</h2>
                        <p>It looks like you haven't scheduled a service. Book your first service today!</p>
                        <a href="dashboard#filter-section" class="btn btn-primary">Book a Service</a>
                    </div>
                    <div th:unless="${#lists.isEmpty(bookings)}">
                        <div th:each="booking : ${bookings}" class="service-card scroll-animate"
                            th:data-status="${booking.status.toLowerCase()}">
                            <div class="service-card-header">
                                <div>
                                    <p class="booking-id" th:text="'BOOKING ID: #' + ${booking.id}"></p>
                                    <p class="booking-date"
                                        th:text="'Booked on: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy')}">
                                    </p>
                                </div>
                                <div>
                                    <p>Payment: <span
                                            th:text="${booking.razorpayPaymentId != null ? 'Online' : 'Pay at Garage'}"></span>
                                    </p>
                                    <p class="service-total"><strong>Total: â‚¹<span
                                                th:text="${#numbers.formatDecimal(booking.totalFee, 0, 2)}"></span></strong>
                                    </p>
                                </div>
                            </div>
                            <div class="service-card-body">
                                <img th:src="${booking.garage.cardImage != null} ? @{/uploads/garage-cards/{file}(file=${booking.garage.cardImage})} : @{https://placehold.co/120x120/d1d5db/334155?text=Garage}"
                                    alt="Garage Profile" class="service-card-img">
                                <div class="service-details">
                                    <h3 th:text="${booking.garage.garageName}">Garage Name</h3>
                                    <p th:text="${booking.garage.address}">Garage Address</p>
                                    <p><strong>Services:</strong> <span
                                            th:text="${#strings.listJoin(booking.bookingServiceItems.![particularGarageService.service.name], ', ')}"></span>
                                    </p>
                                    <p><strong>Vehicle:</strong> <span
                                            th:text="${booking.vehicleMake} + ' ' + ${booking.vehicleModel} + ' (' + ${booking.vehicleNumber} + ')'"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="service-timeline">
                                <!-- Timeline for non-cancelled bookings -->
                                <div th:if="${!booking.status.equalsIgnoreCase('Cancelled')}" class="timeline-group">
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Booked') || booking.status.equalsIgnoreCase('In Progress') || booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Booked</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('In Progress') || booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">In Progress</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Completed</div>
                                    </div>
                                </div>
                                <!-- Timeline for cancelled bookings -->
                                <div th:if="${booking.status.equalsIgnoreCase('Cancelled')}"
                                    class="timeline-group cancelled">
                                    <div class="timeline-step completed">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Booked</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Cancelled') ? 'completed' : ''}"
                                        class="timeline-step cancelled-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Cancelled</div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-actions">
                                <div th:if="${booking.status.equalsIgnoreCase('Completed')}">
                                    <a th:href="@{ /user/invoice/{id}(id=${booking.id})}" target="_blank" class="btn">
                                        View Invoice</a>
                                    <a href="#" class="btn">Rate & Review</a>
                                    <a href="#" class="btn btn-primary">Book Again</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('Booked')}">
                                    <a href="#" class="btn">Need Help?</a>
                                    <a href="#" class="btn btn-primary cancel-booking-btn"
                                        th:data-booking-id="${booking.id}">Cancel Booking</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('Cancelled')}">
                                    <a href="#" class="btn btn-primary">Book Again</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('In Progress')}">
                                    <a href="#" class="btn btn-primary">Need Help?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer th:replace="~{fragments/footer::footer}"></footer>

    <script th:src="@{/javascript/script.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) { entry.target.classList.add('is-visible'); }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.scroll-animate').forEach(el => observer.observe(el));

            // Service page filter logic
            const filterButtons = document.querySelectorAll('.filter-btn');
            const serviceCards = document.querySelectorAll('.service-card');
            const noBookingsMessage = document.getElementById('no-bookings-message');

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filter = button.dataset.filter;

                    let cardsFound = false;
                    serviceCards.forEach(card => {
                        const cardStatus = card.dataset.status;
                        if (filter === 'all' || cardStatus === filter) {
                            card.style.display = 'flex';
                            cardsFound = true;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    if (noBookingsMessage) {
                        if (cardsFound) {
                            noBookingsMessage.style.display = 'none';
                        } else {
                            noBookingsMessage.style.display = 'block';
                        }
                    }
                });
            });
        });
    </script>
</body>

</html>