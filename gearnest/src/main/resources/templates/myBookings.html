<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Bookings - GearNest</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/mybookings.css}" />
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" th:href="@{/images/logo.png}" type="image/x-icon">
</head>

<body>
    <header th:replace="~{fragments/header::header}"></header>
    <main>
        <section class="page-section">
            <div class="container">
                <div class="section-title">
                    <h1>My Bookings</h1>
                </div>

                <div class="service-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="booked">Booked</button>
                    <button class="filter-btn" data-filter="in progress">In Progress</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                    <button class="filter-btn" data-filter="cancelled">Cancelled</button>
                </div>

                <div class="service-list">
                    <div id="no-bookings-message" th:if="${#lists.isEmpty(bookings)}" class="alert alert-info"
                        style="display: block;">
                        <h2>You have no bookings yet.</h2>
                        <p>It looks like you haven't scheduled a service. Book your first service today!</p>
                        <a href="/user/book-service" class="btn btn-primary">Book a Service</a>
                    </div>
                    <div th:unless="${#lists.isEmpty(bookings)}">
                        <div th:each="booking : ${bookings}" class="service-card scroll-animate"
                            th:data-status="${booking.status.toLowerCase()}">
                            <div class="service-card-header">
                                <div>
                                    <p class="booking-id" th:text="'BOOKING ID: #' + ${booking.id}"></p>
                                    <p class="booking-date"
                                        th:text="'Booked on: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy')}">
                                    </p>
                                </div>
                                <div>
                                    <p>Payment: <span
                                            th:text="${booking.razorpayPaymentId != null ? 'Online' : 'Pay at Garage'}"></span>
                                    </p>
                                    <p class="service-total"><strong>Total: â‚¹<span
                                                th:text="${#numbers.formatDecimal(booking.totalFee, 0, 2)}"></span></strong>
                                    </p>
                                </div>
                            </div>
                            <div class="service-card-body">
                                <img th:src="${booking.garage.cardImage != null} ? @{/uploads/garage-cards/{file}(file=${booking.garage.cardImage})} : @{https://placehold.co/120x120/d1d5db/334155?text=Garage}"
                                    alt="Garage Profile" class="service-card-img">
                                <div class="service-details">
                                    <h3 th:text="${booking.garage.garageName}">Garage Name</h3>
                                    <p th:text="${booking.garage.address}">Garage Address</p>
                                    <p><strong>Services:</strong> <span
                                            th:text="${#strings.listJoin(booking.bookingServiceItems.![particularGarageService.service.name], ', ')}"></span>
                                    </p>
                                    <p><strong>Vehicle:</strong> <span
                                            th:text="${booking.vehicleMake} + ' ' + ${booking.vehicleModel} + ' (' + ${booking.vehicleNumber} + ')'"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="service-timeline">
                                <!-- Timeline for non-cancelled bookings -->
                                <div th:if="${!booking.status.equalsIgnoreCase('Cancelled')}" class="timeline-group">
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Booked') || booking.status.equalsIgnoreCase('In Progress') || booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Booked</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('In Progress') || booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">In Progress</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Completed') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Completed</div>
                                    </div>
                                </div>
                                <!-- Timeline for cancelled bookings -->
                                <div th:if="${booking.status.equalsIgnoreCase('Cancelled')}"
                                    class="timeline-group cancelled">
                                    <div th:classappend="${!booking.status.equalsIgnoreCase('Cancelled') ? 'completed' : ''}"
                                        class="timeline-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Booked</div>
                                    </div>
                                    <div th:classappend="${booking.status.equalsIgnoreCase('Cancelled') ? 'completed' : ''}"
                                        class="timeline-step cancelled-step">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-step-label">Cancelled</div>
                                    </div>
                                </div>
                            </div>
                            <div class="service-actions">
                                <div th:if="${booking.status.equalsIgnoreCase('Completed')}">
                                    <a th:href="@{ /user/invoice/{id}(id=${booking.id})}" target="_blank" class="btn">
                                        View Invoice</a> <a th:href="@{/user/feedback(bookingId=${booking.id})}"
                                        class="btn">Rate & Review</a>
                                    <a th:href="@{/dashboard#filter-section}" class="btn btn-primary">Book Again</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('Booked')}">
                                    <a href="#" class="btn">Need Help?</a>
                                    <a href="#" class="btn btn-primary cancel-booking-btn"
                                        th:data-booking-id="${booking.id}">Cancel Booking</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('Cancelled')}">
                                    <a th:href="@{/dashboard#filter-section}" class="btn btn-primary">Book Again</a>
                                </div>
                                <div th:if="${booking.status.equalsIgnoreCase('In Progress')}">
                                    <a href="#" class="btn btn-primary">Need Help?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer th:replace="~{fragments/footer::footer}"></footer>


    <script th:src="@{/javascript/sweetalert2@11.js}"></script>
    <script th:src="@{/javascript/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/javascript/script.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) { entry.target.classList.add('is-visible'); }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.scroll-animate').forEach(el => observer.observe(el));

            // Service page filter logic
            const filterButtons = document.querySelectorAll('.filter-btn');
            const serviceCards = document.querySelectorAll('.service-card');
            const noBookingsMessage = document.getElementById('no-bookings-message');

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filter = button.dataset.filter;

                    let cardsFound = false;
                    serviceCards.forEach(card => {
                        const cardStatus = card.dataset.status;
                        if (filter === 'all' || cardStatus === filter) {
                            card.style.display = 'flex';
                            cardsFound = true;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    if (noBookingsMessage) {
                        if (cardsFound) {
                            noBookingsMessage.style.display = 'none';
                        } else {
                            noBookingsMessage.style.display = 'block';
                        }
                    }
                });
            });

            // Handle Cancel Booking button click
            const cancelButtons = document.querySelectorAll('.cancel-booking-btn');
            cancelButtons.forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.preventDefault();
                    const bookingId = event.target.dataset.bookingId;

                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You want to cancel this booking?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, cancel it!'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                title: 'Sending OTP...',
                                text: 'Please wait, this may take a moment.',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            try {
                                const response = await fetch('/user/send-otp', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded'
                                    },
                                    body: new URLSearchParams({
                                        'bookingId': bookingId
                                    })
                                });

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(errorText);
                                }

                                Swal.fire({
                                    title: 'OTP Sent!',
                                    text: "Please check your email for the OTP to confirm cancellation.",
                                    input: 'text',
                                    inputPlaceholder: 'Enter OTP',
                                    showCancelButton: true,
                                    confirmButtonText: 'Verify OTP',
                                    showLoaderOnConfirm: true,
                                    preConfirm: async (otp) => {
                                        try {
                                            const otpResponse = await fetch('/user/cancel-booking-with-otp', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/x-www-form-urlencoded'
                                                },
                                                body: new URLSearchParams({
                                                    'bookingId': bookingId,
                                                    'otp': otp
                                                })
                                            });

                                            if (!otpResponse.ok) {
                                                const errorText = await otpResponse.text();
                                                throw new Error(errorText);
                                            }
                                            return await otpResponse.text();
                                        } catch (error) {
                                            Swal.showValidationMessage(`Request failed: ${error}`);
                                        }
                                    },
                                    allowOutsideClick: () => !Swal.isLoading()
                                }).then((otpResult) => {
                                    if (otpResult.isConfirmed) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Cancelled!',
                                            text: otpResult.value,
                                        }).then(() => {
                                            location.reload();
                                        });
                                    }
                                });

                            } catch (error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: `Failed to cancel booking: ${error.message}`,
                                });
                            }
                        }
                    });
                });
            });
        });
    </script>
</body>

</html>